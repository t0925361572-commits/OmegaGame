<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>歐米伽訓練遊戲（V9.9 )</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f6fa;color:#222;margin:0;padding:20px;text-align:center}
  .container{max-width:760px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{margin:0 0 8px;font-size:20px;color:#007bff}
  p.lead{margin:6px 0 12px;color:#555}
  #questionBox{min-height:80px;border-radius:8px;background:#fafafa;padding:14px;margin-bottom:12px;border:1px solid #eee;text-align:left;white-space:pre-line}
  #qmeta{font-size:13px;color:#666;margin-bottom:6px}
  #qtext{font-size:18px;line-height:1.5}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .answer-btn{background:#17a2b8;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:18px;font-weight:bold;min-width:80px;}
  .answer-btn:hover{background:#138496}
  .answer-btn:disabled{background:#6c757d;cursor:not-allowed;}
  
  button{background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-size:15px;transition:background .2s}
  button:hover{background:#0056b3}
  button:disabled{background:#6c757d;cursor:not-allowed}
  button.secondary{background:#6c757d}
  button.secondary:hover{background:#5a6268}
  #score{font-size:18px;color:#007bff;margin-top:10px}
  #progress{width:100%;height:12px;background:#e9ecef;border-radius:10px;margin-top:8px;overflow:hidden}
  #progressBar{height:100%;width:0%;transition:width .3s;background:#28a745}
  #feedback{margin-top:10px;min-height:30px}
  .ok{color:#198754;background:#e7f7e7;padding:8px;border-radius:6px;border:1px solid #198754;display:inline-block}
  .bad{color:#c82333;background:#fde8e8;padding:8px;border-radius:6px;border:1px solid #c82333;display:inline-block}
  footer{margin-top:14px;font-size:13px;color:#666;text-align:center;}
  #loginScreen input{border:1px solid #ddd;border-radius:6px;}
  #currentUser{margin:10px 0;font-weight:bold;color:#007bff;}
  @media(max-width:520px){.answer-btn{padding:10px 20px;font-size:16px;}}
</style>
</head>
<body>
<div class="container">

  <!-- 登入區 -->
  <div id="loginScreen">
    <h1>OMEGA 腕錶訓練系統</h1>
    <p>請輸入您的 <strong>5 位數工號</strong> 開始訓練</p>
    <input type="text" id="employeeId" placeholder="例：00123" maxlength="5" inputmode="numeric">
    <button id="loginBtn">登入訓練</button>
    <p id="loginStatus"></p>
  </div>

  <!-- 遊戲主體（登入後顯示）-->
  <div id="gameContainer" style="display:none;">
    <div id="currentUser"></div>
    <button id="logoutBtn" class="secondary" style="margin-bottom:10px;">登出 / 切換工號</button>

    <h1>歐米伽訓練遊戲（V9.9）</h1>
    <p class="lead">每輪 5 題 • 點擊 A 或 B 按鈕答題 • <strong>5 題全對才算通過一輪</strong></p>

    <div id="questionBox">
      <div id="qmeta">按「開始」抽題</div>
      <div id="qtext">準備好了嗎？</div>
    </div>

    <div class="controls">
      <button id="btnA" class="answer-btn" disabled>A</button>
      <button id="btnB" class="answer-btn" disabled>B</button>
    </div>
    <div class="controls" style="margin-top: 16px;">
      <button id="startBtn">開始 / 抽新題</button>
      <button id="reportBtn" class="secondary">下載錯題報告</button>
    </div>

    <div id="score">本輪分數：<span id="scoreVal">0</span>/5</div>
    <div id="progress"><div id="progressBar"></div></div>
    <div id="feedback"></div>

    <footer>
      總輪次（已通過）：<span id="totalRounds">0</span>
    </footer>
  </div>
</div>

<script>
/* V9.9 — 加入工號登入 + 個人化 localStorage 儲存（不改原有邏輯） */
 const allQuestions = [
  // 第一部分：OMEGA 歷史與傳奇（35題）—— A:18 B:17
  {q:"OMEGA 創立於哪一年？\nA. 1894年  B. 1848年", a:"B"},
  {q:"OMEGA 創辦人是誰？\nA. George Daniels  B. Louis Brandt", a:"B"},
  {q:"OMEGA 品牌名稱來自哪個希臘字母？\nA. Alpha  B. Omega", a:"B"},
  {q:"OMEGA 最早以什麼聞名？\nA. 潛水錶  B. 精準懷錶機芯", a:"B"},
  {q:"19世紀末，OMEGA 推出哪款傳奇機芯？\nA. 8800機芯  B. 19令機芯", a:"B"},
  {q:"1932年，OMEGA 首次成為哪項賽事官方計時？\nA. F1  B. 奧運", a:"B"},
  {q:"1932年洛杉磯奧運，OMEGA 提供什麼設備？\nA. 電子計時  B. 手動碼表", a:"B"},
  {q:"1932年發明的『Marine』是什麼？\nA. 首款計時碼表  B. 首款商業潛水錶", a:"B"},
  {q:"1965年，超霸通過 NASA 幾項嚴苛測試？\nA. 6項  B. 10項", a:"B"},
  {q:"哪位太空人首次登月時佩戴超霸？\nA. 阿姆斯壯  B. 巴茲·艾德林", a:"B"},
  {q:"1969年7月21日，誰踏上月球時佩戴超霸？\nA. 阿姆斯壯  B. 巴茲·艾德林", a:"B"},
  {q:"阿波羅13號任務中，超霸計時幾秒？\nA. 30秒  B. 14秒", a:"B"},
  {q:"OMEGA 因阿波羅13號獲頒什麼獎？\nA. 奧運獎章  B. 史努比獎", a:"B"},
  {q:"史努比獎是 NASA 的什麼獎項？\nA. 一般獎項  B. 最高榮譽", a:"B"},
  {q:"2019年，OMEGA 隨誰下潛馬里亞納海溝？\nA. 詹姆斯·卡麥隆  B. 維克多·維斯科沃", a:"B"},
  {q:"五大洋探險使用什麼潛水器？\nA. Deepsea Challenger  B. Limiting Factor", a:"B"},
  {q:"Planet Ocean Ultra Deep 防水深度？\nA. 10000米  B. 6000米", a:"B"},
  {q:"Ultra Deep 使用什麼鋼材？\nA. 鈦合金  B. O-MEGASTEEL", a:"B"},
  {q:"OMEGA 屬於哪個集團？\nA. LVMH  B. Swatch Group", a:"B"},
  {q:"OMEGA 是哪國品牌？\nA. 德國  B. 瑞士", a:"B"},
  {q:"OMEGA 建廠地點在哪？\nA. 日內瓦  B. 比爾", a:"B"},
  {q:"1931年日內瓦天文台競賽，OMEGA 拿下幾類第一？\nA. 3類  B. 6類", a:"B"},
  {q:"OMEGA 奧運計時從哪年開始？\nA. 1928年  B. 1932年", a:"B"},
  {q:"超霸系列最早推出年份？\nA. 1965年  B. 1957年", a:"B"},
  {q:"OMEGA 四大系列包含鐵霸嗎？\nA. 是  B. 否（已停產）", a:"B"},
  {q:"OMEGA 品牌創立時的名稱是？\nA. Omega Watch Co.  B. La Generale Watch Co.", a:"B"},
  {q:"19令機芯的意義是？\nA. 量產化精準  B. 藝術裝飾", a:"A"},
  {q:"1932年奧運，OMEGA 提供幾支計時器？\nA. 1支  B. 30支", a:"B"},
  {q:"NASA 1965年測試超霸包含？\nA. 真空高溫  BControlled環境", a:"A"},
  {q:"阿波羅13號爆炸後，超霸用來？\nA. 校正引擎點火  B. 測量心跳", a:"A"},
  {q:"史努比獎頒發年份？\nA. 1970年  B. 1969年", a:"A"},
  {q:"維克多·維斯科沃下潛次數？\nA. 1次  B. 5次（五大洋）", a:"B"},
  {q:"Ultra Deep 錶殼材質？\nA. 鈦合金  B. O-MEGASTEEL", a:"B"},
  {q:"OMEGA 現任總部在哪？\nA. 日內瓦  B. 比爾", a:"B"},
  {q:"OMEGA 奧運計時至今超過？\nA. 80年  B. 90年", a:"B"},

  // 第二部分：四大系列核心定位（40題）—— A:20 B:20
  {q:"超霸系列別稱是？\nA. 海洋錶  B. 月球錶", a:"B"},
  {q:"超霸專業款機芯是？\nA. 8800  B. 3861", a:"B"},
  {q:"超霸專業款防水深度？\nA. 300米  B. 50米", a:"B"},
  {q:"超霸非對稱錶殼原因？\nA. 美觀  B. 保護按鈕", a:"B"},
  {q:"Dark Side of the Moon 材質？\nA. 鋼  B. 陶瓷", a:"B"},
  {q:"超霸陶瓷款機芯？\nA. 手動上鏈  B. 自動上鏈", a:"B"},
  {q:"超霸 ’57 推出年份？\nA. 2021年  B. 2013年", a:"B"},
  {q:"超霸38mm系列主打？\nA. 專業計時  B. 小巧優雅", a:"B"},
  {q:"海馬系列核心精神？\nA. 太空探險  B. 海洋潛水", a:"B"},
  {q:"Diver 300M 屬於哪個系列？\nA. 超霸  B. 海馬", a:"B"},
  {q:"Diver 300M 官方防水等級？\nA. 600米  B. 300米", a:"B"},
  {q:"Diver 300M 2018年升級重點？\nA. 換成石英  B. 8800機芯+陶瓷圈", a:"B"},
  {q:"Diver 300M 面盤波浪紋如何製作？\nA. 手工上漆  B. 雷射鐫刻", a:"B"},
  {q:"Diver 300M 排氦閥形狀？\nA. 圓形  B. 圓錐形", a:"B"},
  {q:"Diver 300M 錶圈材質？\nA. 鋁  B. 陶瓷", a:"B"},
  {q:"Aqua Terra 屬於哪個系列？\nA. 星座  B. 海馬", a:"B"},
  {q:"Aqua Terra 防水等級？\nA. 300米  B. 150米", a:"B"},
  {q:"Aqua Terra 面盤靈感？\nA. 月球表面  B. 遊艇甲板", a:"B"},
  {q:"Planet Ocean 防水深度？\nA. 300米  B. 600米", a:"B"},
  {q:"Planet Ocean 排氦閥位置？\nA. 2點鐘  B. 10點鐘", a:"B"},
  {q:"星座系列標誌是？\nA. 測速圈  B. 托爪", a:"B"},
  {q:"星座托爪功能？\nA. 裝飾  B. 固定錶鏡", a:"B"},
  {q:"Globemaster 屬於哪個系列？\nA. 碟飛  B. 星座", a:"B"},
  {q:"Globemaster 面盤俗稱？\nA. 波浪紋  B. 鬆餅紋", a:"B"},
  {q:"碟飛系列定位？\nA. 運動耐用  B. 正裝優雅", a:"B"},
  {q:"碟飛系列強調？\nA. 複雜功能  B. 極簡美學", a:"B"},
  {q:"碟飛 Prestige 常見動力？\nA. 石英  B. 機械", a:"B"},
  {q:"星座系列有潛水款嗎？\nA. 有  B. 無", a:"B"},
  {q:"碟飛系列有計時碼表嗎？\nA. 沒有  B. 少數有", a:"B"},
  {q:"Diver 300M 錶帶選擇？\nA. 僅皮革  B. 橡膠與精鋼", a:"B"},
  {q:"Diver 300M 錶帶整合式？\nA. 否  B. 是", a:"B"},
  {q:"超霸專業款鏡面？\nA. 藍寶石  B. Hesalite", a:"B"},
  {q:"Hesalite 鏡面特點？\nA. 防刮  B. 防碎", a:"B"},
  {q:"Aqua Terra 面盤有柚木紋？\nA. 否  B. 是", a:"B"},
  {q:"Planet Ocean 39.5mm 適合？\nA. 專業潛水  B. 日常佩戴", a:"B"},
  {q:"超霸有女款嗎？\nA. 無  B. 有38mm", a:"B"},
  {q:"星座有鑽石款嗎？\nA. 無  B. 有", a:"B"},
  {q:"碟飛有月相款嗎？\nA. 無  B. 有", a:"B"},
  {q:"海馬系列包含正裝款？\nA. 無  B. 有Aqua Terra", a:"B"},
  {q:"超霸有GMT功能？\nA. 無  B. 有", a:"B"},

  // 第三部分：關鍵技術與認證（35題）—— A:18 B:17
  {q:"Co-Axial 擒縱由誰發明？\nA. Louis Brandt  B. George Daniels", a:"B"},
  {q:"Co-Axial 商用年份？\nA. 2005年  B. 1999年", a:"B"},
  {q:"Co-Axial 最大好處？\nA. 增加重量  B. 減少摩擦、保養週期長", a:"B"},
  {q:"Co-Axial 保養週期？\nA. 每年一次  B. 5-8年", a:"B"},
  {q:"Master Chronometer 由誰執行？\nA. COSC  B. METAS", a:"B"},
  {q:"METAS 抗磁標準？\nA. 5,000高斯  B. 15,000高斯", a:"B"},
  {q:"要獲得 METAS 認證，必須先通過？\nA. ISO防水  B. COSC", a:"B"},
  {q:"METAS 測試項目數量？\nA. 5項  B. 8項", a:"B"},
  {q:"METAS 測試包含日常佩戴情境？\nA. 否  B. 是", a:"B"},
  {q:"Si14 矽游絲主要優點？\nA. 增加重量  B. 抗磁抗震", a:"B"},
  {q:"Si14 游絲受溫度影響小？\nA. 否  B. 是", a:"B"},
  {q:"Sedna™ Gold 是什麼？\nA. 陶瓷  B. 18K玫瑰金合金", a:"B"},
  {q:"Sedna™ Gold 含何金屬？\nA. 鉑  B. 鈀", a:"B"},
  {q:"Sedna金會褪色嗎？\nA. 會  B. 不會", a:"B"},
  {q:"Liquidmetal™ 用於？\nA. 指針  B. 錶圈刻度", a:"B"},
  {q:"Liquidmetal™ 永不褪色？\nA. 否  B. 是", a:"B"},
  {q:"Ceragold™ 技術用於？\nA. 鋼+陶瓷  B. 陶瓷+黃金", a:"B"},
  {q:"3861機芯動力儲存？\nA. 55小時  B. 50小時", a:"B"},
  {q:"8800機芯動力儲存？\nA. 72小時  B. 55小時", a:"B"},
  {q:"排氦閥主要功能？\nA. 計時啟動  B. 飽和潛水排氣", a:"B"},
  {q:"OMEGA 抗磁技術解決什麼痛點？\nA. 溫度變化  B. 手機磁場", a:"B"},
  {q:"Co-Axial 提升精準度？\nA. 否  B. 是", a:"B"},
  {q:"METAS 測試包含磁場模擬？\nA. 否  B. 是", a:"B"},
  {q:"O-MEGASTEEL 硬度比傳統鋼高？\nA. 否  B. 是", a:"B"},
  {q:"Diver 300M 指針材質？\nA. 鋁  B. 夜光塗層鋼", a:"B"},
  {q:"超霸專業款有藍寶石鏡面款？\nA. 無  B. 有", a:"B"},
  {q:"Aqua Terra 有計時功能？\nA. 有  B. 無", a:"B"},
  {q:"Globemaster 有年曆功能？\nA. 無  B. 有", a:"B"},
  {q:"Sedna金比傳統玫瑰金耐用？\nA. 否  B. 是", a:"B"},
  {q:"Liquidmetal比傳統漆耐刮？\nA. 否  B. 是", a:"B"},
  {q:"8800機芯有矽游絲？\nA. 無  B. 有", a:"B"},
  {q:"3861機芯有矽游絲？\nA. 有  B. 無", a:"B"},
  {q:"METAS 認證需每日誤差？\nA. -5/+5秒  B. 0/+5秒", a:"B"},
  {q:"COSC 認證需每日誤差？\nA. -4/+6秒  B. 0/+5秒", a:"A"},
  {q:"OMEGA 抗磁領先業界？\nA. 否  B. 是", a:"B"},

  // 第四部分：銷售話術實戰（40題）—— A:19 B:21
  {q:"客戶問：『為什麼要買OMEGA？』\nA. 只是瑞士錶  B. 登月+奧運+抗磁", a:"B"},
  {q:"客戶問：『超霸為何叫月球錶？』\nA. 面盤像月球  B. 唯一登月認證", a:"B"},
  {q:"客戶問：『海馬可以每天戴嗎？』\nA. 不行，只適合潛水  B. 可以，Aqua Terra 150米", a:"B"},
  {q:"客戶問：『星座適合送禮嗎？』\nA. 不適合，太運動  B. 適合，托爪設計經典", a:"B"},
  {q:"客戶問：『碟飛跟星座差在哪？』\nA. 碟飛更防水  B. 碟飛更簡約正裝", a:"B"},
  {q:"客戶問：『OMEGA抗磁強嗎？』\nA. 一般，1,000高斯  B. 強，15,000高斯", a:"B"},
  {q:"客戶問：『為什麼保養週期長？』\nA. 機芯更大  B. Co-Axial減少摩擦", a:"B"},
  {q:"客戶問：『Diver 300M為何有排氦閥？』\nA. 裝飾用  B. 專業飽和潛水", a:"B"},
  {q:"客戶問：『Aqua Terra可以游泳嗎？』\nA. 不行，只適合洗手  B. 可以，150米防水", a:"B"},
  {q:"客戶問：『超霸可以戴去潛水嗎？』\nA. 可以，300米  B. 不建議，只50米", a:"B"},
  {q:"客戶問：『陶瓷錶圈會刮傷嗎？』\nA. 很容易  B. 幾乎不會", a:"B"},
  {q:"客戶問：『Sedna金會褪色嗎？』\nA. 會，需鍍層  B. 不會，含鈀穩定色澤", a:"B"},
  {q:"客戶問：『為什麼Globemaster叫鬆餅紋？』\nA. 機芯像鬆餅  B. 面盤紋路像鬆餅", a:"B"},
  {q:"客戶問：『OMEGA是哪國品牌？』\nA. 德國  B. 瑞士", a:"B"},
  {q:"客戶問：『OMEGA屬於哪個集團？』\nA. LVMH  B. Swatch Group", a:"B"},
  {q:"客戶問：『Diver 300M 2018年改了什麼？』\nA. 換成石英  B. 升級8800機芯+陶瓷圈", a:"B"},
  {q:"客戶問：『超霸有自動上鏈嗎？』\nA. 沒有，全是石英  B. 有，但專業款是手動", a:"B"},
  {q:"客戶問：『星座有潛水款嗎？』\nA. 有，300米  B. 沒有，主打正裝", a:"B"},
  {q:"客戶問：『碟飛有計時碼表嗎？』\nA. 沒有，完全沒有  B. 少數有，但不主打", a:"A"},
  {q:"客戶問：『OMEGA保養要幾年一次？』\nA. 每年一次  B. 5-8年", a:"B"},
  {q:"客戶問：『為什麼超霸按鈕在2點和4點？』\nA. 隨機設計  B. 非對稱殼保護按鈕", a:"B"},
  {q:"客戶問：『Aqua Terra面盤為何有柚木紋？』\nA. 隨機裝飾  B. 靈感來自遊艇甲板", a:"B"},
  {q:"客戶問：『Planet Ocean有女款嗎？』\nA. 沒有，全是大錶  B. 有，39.5mm", a:"B"},
  {q:"客戶問：『超霸陶瓷款叫什麼？』\nA. White Side  B. Dark Side of the Moon", a:"B"},
  {q:"客戶問：『OMEGA值得信賴嗎？』\nA. 一般，僅外觀  B. 值得，歷史+科技雙冠軍", a:"B"},
  {q:"客戶問：『Diver 300M 藍色陶瓷面盤最受歡迎？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『Aqua Terra 綠色面盤近年流行？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『超霸 Moonshine™ Gold 色澤？』\nA. 鮮豔  B. 淡雅", a:"B"},
  {q:"客戶問：『星座有鑽石款嗎？』\nA. 無  B. 有", a:"B"},
  {q:"客戶問：『碟飛有月相嗎？』\nA. 無  B. 有", a:"B"},
  {q:"客戶問：『OMEGA 抗磁技術領先業界？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『超霸有GMT功能？』\nA. 無  B. 有", a:"B"},
  {q:"客戶問：『海馬有正裝款？』\nA. 無  B. 有", a:"B"},
  {q:"客戶問：『星座有測速圈？』\nA. 有  B. 無", a:"B"},
  {q:"客戶問：『碟飛有排氦閥？』\nA. 有  B. 無", a:"B"},
  {q:"客戶問：『Co-Axial 提升精準度？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『METAS 測試包含磁場模擬？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『Aqua Terra 41mm 適合商務？』\nA. 否  B. 是", a:"B"},
  {q:"客戶問：『超霸38mm 卡布奇諾款溫暖？』\nA. 否  B. 是", a:"B"},
  {q:"最後一題：你最推薦客戶的第一支OMEGA？\nA. 鐵霸（已停產）  B. Aqua Terra（全能日常）", a:"B"}
];

// ---------- 狀態 ----------
let pool = [], currentBatch = [], currentQIndex = 0, currentScore = 0, totalRounds = 0;
let currentBatchFailed = false;
const wrongLog = new Map();
const roundSize = 5;
let gameActive = false;
let currentEmployeeId = null;

// UI refs
const loginScreen = document.getElementById('loginScreen');
const gameContainer = document.getElementById('gameContainer');
const employeeIdInput = document.getElementById('employeeId');
const loginBtn = document.getElementById('loginBtn');
const loginStatus = document.getElementById('loginStatus');
const currentUserEl = document.getElementById('currentUser');
const logoutBtn = document.getElementById('logoutBtn');

const qmeta = document.getElementById('qmeta'), qtext = document.getElementById('qtext');
const btnA = document.getElementById('btnA'), btnB = document.getElementById('btnB');
const startBtn = document.getElementById('startBtn'), reportBtn = document.getElementById('reportBtn');
const scoreVal = document.getElementById('scoreVal'), progressBar = document.getElementById('progressBar');
const totalRoundsEl = document.getElementById('totalRounds');
const feedbackEl = document.getElementById('feedback');

// ---------- localStorage 工具 ----------
function getStorageKey(id, key) { return `omega_${id}_${key}`; }

function loadUserData(id) {
  const rounds = localStorage.getItem(getStorageKey(id, 'rounds'));
  const wrongs = localStorage.getItem(getStorageKey(id, 'wrongs'));
  totalRounds = rounds ? parseInt(rounds) : 0;
  wrongLog.clear();
  if (wrongs) {
    const data = JSON.parse(wrongs);
    data.forEach(w => wrongLog.set(w.q, w));
  }
}

function saveUserData(id) {
  localStorage.setItem(getStorageKey(id, 'rounds'), totalRounds);
  const wrongsArray = Array.from(wrongLog.values());
  localStorage.setItem(getStorageKey(id, 'wrongs'), JSON.stringify(wrongsArray));
}

// ---------- 登入系統 ----------
loginBtn.addEventListener('click', () => {
  const input = employeeIdInput.value.trim();
  if (!/^\d{5}$/.test(input)) {
    loginStatus.textContent = '請輸入正確的 5 位數字工號！';
    loginStatus.style.color = '#c82333';
    return;
  }
  currentEmployeeId = input;
  loadUserData(currentEmployeeId);
  initPool();
  loginScreen.style.display = 'none';
  gameContainer.style.display = 'block';
  currentUserEl.textContent = `員工工號：${currentEmployeeId}（已載入進度）`;
  totalRoundsEl.textContent = totalRounds;
  loginStatus.textContent = '';
});

logoutBtn.addEventListener('click', () => {
  if (gameActive && currentQIndex < roundSize && !confirm("目前輪次未完成，確定登出？")) return;
  saveUserData(currentEmployeeId);
  currentEmployeeId = null;
  wrongLog.clear();
  gameContainer.style.display = 'none';
  loginScreen.style.display = 'block';
  employeeIdInput.value = '';
  initializeGame();
});

// ---------- 遊戲邏輯（完全不變）----------
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function initPool(){ pool = allQuestions.slice(); shuffleArray(pool); }

function startNewRound(){
  if(gameActive && currentQIndex < roundSize) {
    if(!confirm("目前這輪還沒答完，確定要直接開始新的一輪嗎？")) return;
  }
  if(pool.length < roundSize){
      initPool();
      alert("題庫不足！已將所有未通過的題目重新洗牌。");
  }
  gameActive = true;
  currentBatchFailed = false;
  currentBatch = pool.splice(0, roundSize);
  currentQIndex = 0;
  currentScore = 0;
  updateUIForNewRound();
  showCurrentQuestion();
}

function showCurrentQuestion(){
  if(!gameActive || currentQIndex >= currentBatch.length) return;
  const q = currentBatch[currentQIndex];
  qmeta.textContent = `第 ${currentQIndex + 1} 題（本輪 ${currentQIndex + 1}/${roundSize}）`;
  qtext.textContent = q.q;
  feedbackEl.innerHTML = '';
  updateUI();
}

function updateUI(){
  scoreVal.textContent = currentScore;
  progressBar.style.width = `${(currentQIndex / roundSize) * 100}%`;
  totalRoundsEl.textContent = totalRounds;
  btnA.disabled = !gameActive;
  btnB.disabled = !gameActive;
}

function updateUIForNewRound() {
    feedbackEl.innerHTML = '';
    updateUI();
}

function submitAnswer(userAnswer){
  if(!gameActive) return;
  const currentQuestion = currentBatch[currentQIndex];
  const correct = (currentQuestion.a || '').toUpperCase();
  
  if(userAnswer === correct){
    currentScore++;
    feedbackEl.innerHTML = '<div class="ok">正確！</div>';
  } else {
    currentBatchFailed = true;
    if(!wrongLog.has(currentQuestion.q)){
        wrongLog.set(currentQuestion.q, currentQuestion);
    }
    feedbackEl.innerHTML = `<div class="bad">錯誤！正確答案：${correct}</div>`;
  }
  
  updateUI();
  btnA.disabled = true;
  btnB.disabled = true;

  setTimeout(() => {
    currentQIndex++;
    if(currentQIndex < roundSize){
      showCurrentQuestion();
    } else {
      gameActive = false;
      progressBar.style.width = '100%';
      let finalMessage = `本輪結束！您的分數是 ${currentScore}/${roundSize}。`;
      
      if(currentBatchFailed){
          pool.push(...currentBatch);
          shuffleArray(pool);
          finalMessage += " 本輪失敗！5 題將重新進入題庫。";
          feedbackEl.innerHTML = `<div class="bad">${finalMessage}</div>`;
          qtext.textContent = "挑戰失敗！點擊「開始 / 抽新題」重新挑戰這 5 題。";
      } else {
          totalRounds++;
          saveUserData(currentEmployeeId);  // 即時儲存
          finalMessage += ` 恭喜！本批次 5 題已成功通過！總輪次：${totalRounds}`;
          feedbackEl.innerHTML = `<div class="ok">${finalMessage}</div>`;
          qtext.textContent = "挑戰成功！點擊「開始 / 抽新題」挑戰下一批次。";
      }
      
      qmeta.textContent = "本輪已完成";
      updateUI();
    }
  }, 800);
}

function downloadReport(){
  const now = new Date().toLocaleString('zh-TW');
  let report = `OMEGA 腕錶品牌專業銷售講義（新進人員訓練用）\n`;
  report += `員工工號：${currentEmployeeId} | 報告時間：${now}\n`;
  report += `總輪次（已通過）：${totalRounds}\n\n錯題清單 (不重複):\n`;
  if(wrongLog.size === 0){
    report += "無錯題！完美！\n";
  } else {
    let i = 1;
    wrongLog.forEach(w => {
      report += `${i++}. ${w.q}\n   正確答案: ${w.a}\n\n`;
    });
  }
  const blob = new Blob([report], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `OMEGA_訓練報告_${currentEmployeeId}_${Date.now().toString().slice(-6)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// 事件綁定
btnA.addEventListener('click', () => submitAnswer('A'));
btnB.addEventListener('click', () => submitAnswer('B'));
startBtn.addEventListener('click', startNewRound);
reportBtn.addEventListener('click', downloadReport);

function initializeGame() {
    initPool();
    totalRounds = 0;
    totalRoundsEl.textContent = totalRounds;
    scoreVal.textContent = '0';
    progressBar.style.width = '0%';
    startBtn.disabled = false;
}

// 頁面載入完成
initializeGame();
</script>
</body>
</html>


